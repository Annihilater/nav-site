# 生产环境部署指南

## 数据库迁移部署

本项目使用 Prisma ORM 管理数据库结构。当数据库结构发生变化时，需要在生产环境中应用这些变化。

### 部署前准备

1. 确保生产环境的 `.env` 文件包含正确的数据库连接信息：

```
DATABASE_URL="mysql://用户名:密码@数据库主机:3306/数据库名"
```

2. 确保您有数据库的备份（重要！）

```bash
# 在部署前备份数据库
mysqldump -u 用户名 -p 数据库名 > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 部署方法

我们提供了两种部署数据库变更的方法：

#### 方法一：使用手动 SQL 迁移（推荐）

这种方法适用于 Prisma 迁移历史有问题的情况，它直接执行 SQL 文件：

```bash
./scripts/deploy-db.sh
```

#### 方法二：使用 Prisma Migrate Deploy

这种方法使用 Prisma 官方的迁移工具：

```bash
./scripts/prisma-deploy.sh
```

### 完整部署流程

通常，数据库迁移是整体部署流程的一部分：

```bash
# 执行完整部署脚本
./deploy.sh
```

这个脚本会：

1. 安装依赖
2. 生成 Prisma 客户端
3. 清除缓存
4. 应用数据库迁移
5. 构建应用
6. 创建版本信息
7. 重启应用

## 故障排除

如果在迁移过程中遇到问题：

1. 检查数据库连接是否正确
2. 查看迁移日志
3. 如果需要，从备份中恢复数据库
4. 联系开发团队获取支持
